#!/bin/bash

#  P2P Food Lab Sensorbox
#
#  Copyright (C) 2013  Sony Computer Science Laboratory Paris
#  Author: Peter Hanappe
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.

home_dir=/var/p2pfoodlab
d=`date +"%Y%m%d-%H%M%S"`

log_message() {
    echo $1 >> /var/p2pfoodlab/log.txt
    #echo $1
}

enabled=`$home_dir/bin/config-get camera.enable`
if [ $? != 0 ]; then
    exit 0
fi
if [ "x$enabled" != "xyes" ]; then
    exit 0
fi

if [ -e $home_dir/bin/grab-image ]; then
    $home_dir/bin/grab-image
fi


key=`$home_dir/bin/config-get opensensordata.key`
if [ $? != 0 ]; then
    log_message "[update-photostream @ $d] Error: Failed to read the OpenSensorData API key" 
    exit 0
fi
if [ "x$key" == "x" ]; then
    log_message "[update-photostream @ $d] Error: Couldn't find OpenSensorData API key" 
    exit 0
fi
log_message "[update-photostream @ $d] Info: Got OpenSensorData API key" 

if [ ! -e $home_dir/etc/opensensordata/webcam.json ]; then
    log_message "[update-photostream @ $d] Error: Couldn't find $home_dir/etc/opensensordata/webcam.json" 
    exit 0
fi
id=`$home_dir/bin/config-get -c $home_dir/etc/opensensordata/webcam.json id`
if [ $? != 0 ]; then
    log_message "[update-photostream @ $d] Error: Failed to read the photostream ID" 
    exit 0
fi
if [ "x$id" == "x" ]; then
    log_message "[update-photostream @ $d] Error: Couldn't find photostream ID" 
    exit 0
fi
log_message "[update-photostream @ $d] Info: Photostream ID $id" 

server=`$home_dir/bin/config-get opensensordata.server`
if [ $? != 0 ]; then
    log_message "[update-photostream @ $d] Error: Failed to read the server configuration" 
    exit 0
fi
if [ "x$server" == "x" ]; then
    log_message "[update-photostream @ $d] Error: Couldn't find server configuration" 
    exit 0
fi
log_message "[update-photostream @ $d] Info: OpenSensorData server $server" 

# Upload all the remaining photos on the disk
count=`ls $home_dir/photostream | wc -l`
if [ $count -gt 0 ]; then
    log_message "[update-photostream @ $d] Info: Found $count photos on the disk" 
    cd $home_dir/photostream/
    mkdir -p $home_dir/backup

    for file in *.jpg; do

        log_message "[update-photostream @ $d] Info: Uploading $file" 
        if [ ! -e $file.base64 ]; then
            base64 $file > $file.base64
        fi

        status=$(curl \
            --silent \
            --output $home_dir/backup/$file.out \
            -w "%{http_code}" \
            --data-binary @$file.base64 \
            --header "X-OpenSensorData-Key: $key" \
            --header "Content-Type: application/octet-stream" \
            $server/photo/$id/$file)
            
        log_message "[update-photostream @ $d] Info: HTTP Status: $status" 

        if [ $status == "200" ]; then
            # Remove the local copies if rsync was successful
            log_message "[update-photostream @ $d] Info: Moving image to backup" 
	    mv $file $home_dir/backup
	    rm -f $file.base64
        fi

    done
    cd ..
fi
