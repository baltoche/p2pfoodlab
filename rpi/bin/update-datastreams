#!/bin/bash

home_dir=/var/p2pfoodlab
d=`date +"%Y%m%d-%H%M%S"`

log_message() {
    echo $1 >> /var/p2pfoodlab/log.txt
    #echo $1
}

if [ -e $home_dir/bin/arduino ]; then
    $home_dir/bin/arduino store-data
fi

key=`$home_dir/bin/config-get opensensordata.key`
if [ $? != 0 ]; then
    exit 0
fi

server=`$home_dir/bin/config-get opensensordata.server`
if [ $? != 0 ]; then
    exit 0
fi
if [ "x$server" == "server" ]; then
    exit 0
fi

datetime=`date +"%Y%m%d-%H%M%S"`

# Upload the data, if any
if [ -s $home_dir/datapoints.csv ]; then
    #wget --quiet --post-file=$home_dir/datapoints.csv --output-document=$home_dir/backup/datapoints.$datetime.out "$server/upload?key=$key"

    log_message "[update-datastreams @ $d] Info: Uploading datapoints" 

    status=$(curl \
        --silent \
        --output $home_dir/backup/datapoints.$datetime.out \
        -w "%{http_code}" \
        --data-binary @$home_dir/datapoints.csv \
        --header "X-OpenSensorData-Key: $key" \
        --header "Content-Type: application/octet-stream" \
        $server/upload)

    log_message "[update-datastreams @ $d] Info: HTTP Status: $status" 

#    if [ $? -eq 0 ]; then
    if [ $status == "200" ]; then
        mv $home_dir/datapoints.csv $home_dir/backup/datapoints.$datetime.csv
        gzip $home_dir/backup/datapoints.$datetime.csv
    fi
fi
