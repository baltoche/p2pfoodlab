#!/bin/bash

#  P2P Food Lab Sensorbox
#
#  Copyright (C) 2013  Sony Computer Science Laboratory Paris
#  Author: Peter Hanappe
#
#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.

home_dir=/var/p2pfoodlab
d=`date +"%Y%m%d-%H%M%S"`

log_message() {
    echo $1 >> /var/p2pfoodlab/log.txt
    #echo $1
}

if [ -e $home_dir/bin/arduino ]; then
    $home_dir/bin/arduino store-data
fi

key=`$home_dir/bin/config-get opensensordata.key`
if [ $? != 0 ]; then
    exit 0
fi

server=`$home_dir/bin/config-get opensensordata.server`
if [ $? != 0 ]; then
    exit 0
fi
if [ "x$server" == "server" ]; then
    exit 0
fi

datetime=`date +"%Y%m%d-%H%M%S"`

# Upload the data, if any
if [ -s $home_dir/datapoints.csv ]; then
    #wget --quiet --post-file=$home_dir/datapoints.csv --output-document=$home_dir/backup/datapoints.$datetime.out "$server/upload?key=$key"

    log_message "[update-datastreams @ $d] Info: Uploading datapoints" 

    status=$(curl \
        --silent \
        --output $home_dir/backup/datapoints.$datetime.out \
        -w "%{http_code}" \
        --data-binary @$home_dir/datapoints.csv \
        --header "X-OpenSensorData-Key: $key" \
        --header "Content-Type: application/octet-stream" \
        $server/upload)

    log_message "[update-datastreams @ $d] Info: HTTP Status: $status" 

#    if [ $? -eq 0 ]; then
    if [ $status == "200" ]; then
        mv $home_dir/datapoints.csv $home_dir/backup/datapoints.$datetime.csv
        gzip $home_dir/backup/datapoints.$datetime.csv
    fi
fi
